steal(
	'jquery/controller',
	'jquery/view/ejs',
    'jquery/controller/view',
    'jquery/dom/route',
    'jquery/lang/observe/delegate',
    'docview/models',
    'docview/details/tree',
    'docview/details/viewer',
    
    'docview/bootstrap/bootstrap.css'
)

// View templates
.then(
    './views/init.ejs'
)

.then(function($) {

    /*
    * Tree view for a selected document
    */
    $.Controller('Docview.Details',
    /* @Static */
    {
    },
    /* @Prototype */
    {
        init: function() {
            this.element.html(this.view('init', {}));
            
            // By default we're hidden until the route conditions are met
            this.element.hide();
	    this.to_show = false;

            this.element.find('#document-tree').docview_details_tree({clientState: this.options.clientState});
            this.element.find('#document-viewer').docview_details_viewer({clientState: this.options.clientState});            

	    if (this.options.clientState.attr('access')
                .attr('manage_docs').attr('print')) {
	    } else {
		this.element.find('.bprint').hide();
	    }
	    this.element.find('.bcourt').hide();
        },
        '{$.route} category change': function(el, ev, attr, how, newVal, oldVal)  {
            if (newVal === "document") {
                this.to_show = true; // this.element.show();
            }
            else {
		this.to_show = false;
                this.element.hide();
            }
        },
        '{$.route} page change': function(el, ev, attr, how, newVal, oldVal) {
            // this will have problems when you refresh the page and the event is an add and we
            // don't have the data populated yet
            this.element.find('li').removeClass('active');
            var pageSelector = '.page-' + newVal;
            this.element.find(pageSelector).addClass('active');
        },
        '{$.route} id change': function(el, ev, attr, how, newVal, oldVal) {
            // TODO: If we set category and id values sequentually, are the events done in order?
            //       i.e. does:
            //       $.route.attrs({ "category": "document", "id": "103420121342000022" }, true);
            //       yield:
            //       category change event, followed by id change event?
            // console.log(el, ev);
	    if (newVal == -1) {
		return;
	    }
	    if ($.route.attr('category') === 'document') {
                Docview.Models.File.findOne(newVal, this.proxy('setData'), this.proxy('failure'));
            }
        },
        setData: function(file) {
            /*document: {
                    pages: [] // Array of pages
                    directory: "" // Location of image
                    metadata: {} // metadata
                    groups: [subgroup, subgroup, ...] // groups of images
            }*/
	    var old_sub = $.route.attr('old');
	    if (old_sub != undefined) {
		this.element.find('.bprint').hide();
	    }
	    if (old_sub == 'court') {
		this.element.find('.bcourt').show();
	    } else {
		this.element.find('.bcourt').hide();
	    }
	    this.element.show();


	    var do_filter = false;
	    var filter = this.options.clientState.attr('search').filters;
	    if (filter != undefined && filter.length > 0) {
		console.log(filter);
		do_filter = true;
	    } else {
		console.log("filter is not defined");
	    }
            var metadata = file.doc_info;
            var directory = "/docimages/";

//	    var rowpos = $('div#document-viewer').position();
//	    console.log(rowpos);
//	    window.scrollTo(0, rowpos.top);
//	    $('#container').scrollTop(rowpos.top);

  //          $('div#document-viewer').scrollIntoView(); //window.scroll(0, 200);
            // $('#search-box-container').collapse('hide');
            var groups = new Array();
            var subgroup = new Array();
            var pages = new Array();
            var images = file.image_info.T_blog;
            var prevType;
            var prevGroupName;
   //         for (var i = 0; i < metadata.pages; i++) {
            for (var i = 0; i < images.length; i++) {
		var pt = images[i].TCode;
		
		if (do_filter && pt!=0 && $.inArray(pt, filter)) {
		    continue;
		}
                if (pt !== prevType && prevType !== undefined) {
                    // Push previous subgroup and type into groups
                    groups.push({type: prevType, name: prevGroupName, pages: subgroup});
                    subgroup = new Array();
                }
                subgroup.push(images[i].FN);
                pages.push(images[i].FN);
                
                if (images[i].BT) {
                    subgroup.push(images[i].BT);
                    pageArray.push(images[i].BT);
                }
                prevType = pt;
                prevGroupName = images[i].T;
            }
            // Push our remaining subgroup into groups
            groups.push({type: prevType, name: prevGroupName, pages: subgroup});
            
            //console.log({
            //    pages: pages,
            //    directory: directory,
            //    metadata: metadata,
            //    groups: groups
            //});
            this.options.clientState.attr('document', {
                pages: pages,
                directory: directory,
                metadata: metadata,
                groups: groups
            });
            
            var docid = $.route.attr('id');
	    var message = '以下为该单证电子档案扫描图像信息，原件共' + images.length + '页';

	    this.options.clientState.attr('alert', {
		type: 'info',
		heading: '单证' + docid,
		message : message
	    });

            // Start at page 1 by default
            this.options.clientState.attr('document').attr('current', 1);
        },
	hideAll: function() {
	    this.element.hide();
            this.element.find('#document-tree').docview_details_tree('hideAll');
	},
        failure: function(jqXHR, textStatus, errorThrown) {
	    var t = 'error';
	    var h = '错误提示：';
	    var message = '需要用户认证，请重新登录系统。';
            var docid = $.route.attr('id');

	    if (jqXHR.status == 404) {
               type = 'info';
	       message = '系统中没有单证' + docid + '档案信息';	
	    } else if (jqXHR.status == 403) {
               type = 'info';
               message = '无法查阅单证档案'+ docid + '信息，权限不足。';
            } else if (jqXHR.status == 500) {
               message = '系统内部错误';
            } else if (jqXHR.status == 400) {
	       message = '系统内部错误： 无法获取单证电子图像。';
	    }
	    this.options.clientState.attr('alert', {
		type: t,
		heading: h,
		message : message
	    });
            //console.log("[Error]", data);
        }
    });
});
