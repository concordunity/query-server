steal(
	'jquery/controller',
	'jquery/view/ejs',
    'jquery/controller/view',
    'jquery/dom/route',
    'jquery/lang/observe/delegate',
    'docview/models',
    
    'docview/bootstrap/bootstrap.css',
    './results.css'
)

// View templates
.then(
    './views/results_table.ejs',
    './views/result.ejs'
)

// External JS
.then(
    'docview/datatables/jquery.dataTables.js'
)
.then(
    'docview/datatables/bootstrap-pagination.js'
)

.then(function($) {

    /*
    * Search results for multi-doc and advanced searches
    */
    $.Controller('Docview.Search.Results',
    /* @Static */
    {
    },
    /* @Prototype */
    {
        init: function() {
            // We'll show ourselves during multi or advanced search
            this.element.hide();
            
	    /* Modify default datatables class to work with bootstrap better */
	    $.extend( $.fn.dataTableExt.oStdClasses, {
		"sSortAsc": "header headerSortDown",
		"sSortDesc": "header headerSortUp",
		"sSortable": "header"
	    } );
        },
        '{clientState} search change': function(el, ev, attr, how, newVal, oldVal) {
            var mode = $.route.attr('subcategory');
            if (how === "set" || how === "add") {
		if (mode == 'multi') {
                    this.element.html("Searching...");
                    this.element.show();
                    Docview.Models.File.findAll(
			newVal, //{doc_ids: newVal.ids},
			this.proxy('showResults'),
			function() { console.log('Error') }
                    );
		} else if (newVal == 'advanced') {
		    
		}
            }
        },
        showResults: function(data) {
	    var not_found = data.not_found;
	    if (not_found != undefined && not_found.length > 0) {
		this.options.clientState.attr('alert', {
                    type: 'info',
                    heading: '提示：',
                    message : '系统没有以下单证电子档案扫描图像信息: ' + not_found.join()
		});
	    }
	    
            this.element.html(this.view('results_table', data.results));
            this.element.find('table').dataTable({
                "sDom": "<'row-fluid'<'span6'l><'pull-right'f>r>t<'row-fluid'<'span6'i><'pull-right'p>>",
                "sPaginationType": "bootstrap",
                 "oLanguage" : {
                     "sUrl" : "media/language/ch_ZN.txt"
                 }
            });
        },
        'td a click': function(el, ev) {
            ev.preventDefault();
            var document = el.closest('tr').model();
            $.route.attrs({category: 'document', id: document.doc_id}, true);
        },
        '{$.route} category change': function(el, ev, attr, how, newVal, oldVal)  {
            if (newVal !== "search" && newVal !== 'document') {
                this.element.hide();
            }
        },
        '{$.route} subcategory change': function(el, ev, attr, how, newVal, oldVal)  {
            if (newVal === "multi" && oldVal != "advanced") {
                this.element.show();
            } else if ( newVal === "advanced" && oldVal != "multi") {
		this.element.show();
	    } else {
                this.element.hide();
            }
        }
    });
});
